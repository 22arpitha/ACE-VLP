<div class="container-wrapper settings-main-content px-0">
  <section class="settings-form-bg px-0">
    <div class="row mx-0 my-3 px-2">
<div class="col-12 col-sm-12 col-md-12 col-lg-12 px-0">
  <section class="settings-table-bg" >
    <div class="row row mx-0 px-0" *ngIf="!isEditItem && job_id">
        <div class="col-12 col-sm-12 col-md-12 col-lg-12 my-2 pl-0 pr-5 text-end">
          <button mat-raised-button class="proceedbtn mat-btn-s" type="button" (click)="editJobKPIDetails()" *ngIf="user_role_name !='Admin' && accessPermissions[0]?.update || user_role_name === 'Admin'">Edit</button>
        </div>
      </div>
      <form [formGroup]="jobKPIFormGroup">
      <div class="row mx-0 my-1 px-0">
        <div class="col-12 col-sm-12 col-md-12 col-lg-12 px-0 table-responsive table-responsive-sm table-responsive-md" *ngIf="employeeFormArray.controls.length >= 1">
<mat-accordion formArrayName="data" class="contact-form-content">
  <mat-expansion-panel *ngFor="let emp of currentPageRows; let i = index" [formGroupName]="(currentPage - 1) * pageSize + i">
    <mat-expansion-panel-header style="display: flex; justify-content: space-between; align-items: center;">
    <mat-panel-title>Employee:&nbsp;<span> {{ getEmployeeName(emp.get('employee')?.value) }}</span></mat-panel-title>  
    </mat-expansion-panel-header>
    <table class="table table-list employee-details-table">
    <thead>
        <tr>
            <th>Estimated Time</th>
            <th>Points</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="align-content-center">
                <div class="row mx-0 my-1 px-0 justify-content-center">
 
                            <mat-form-field appearance="outline" class="w-100 custom-mat-form-field px-0">
                                <mat-label>Processing Time</mat-label>
                                <input matInput type="text" placeholder="00:00"  maxlength="6" formControlName="processing_time" autocomplete="off" (input)="formatProcessingTime($event,i)" (focusout)="defaultProcessingTime($event,i)" >
                              </mat-form-field>
                        </div>
                        <div class="row mx-0 my-1 px-0 justify-content-center">
                              <mat-form-field appearance="outline" class="w-100 custom-mat-form-field px-0">
                                <mat-label>Review Time</mat-label>
                                <input matInput type="text" placeholder="000:00"  maxlength="6" formControlName="review_time" autocomplete="off" (input)="formatReviewingTime($event,i)" (focusout)="defaultReviewTime($event,i)" >
                              </mat-form-field> 
                        </div>
                        <div class="row mx-0 my-1 px-0 justify-content-center">
                            <input type="file" accept=".xlsx,.xls,.doc,.docx,.pdf" formControlName="budget_file" #fileInput
                            (change)="onBudgetFileSelected($event,i)" hidden>
                          <div class="image-container w-100 d-flex justify-content-between align-items-center"
                            style="padding: 1px 15px;"
                            [ngClass]="{'is-invalid': emp?.get('budget_file')?.touched && emp?.get('budget_file')?.invalid}">
                            <mat-label *ngIf="selectedBudgetFile[((currentPage - 1) * pageSize + i)] && selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name" [ngbTooltip]="selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name" ><a type="button" (click)="openFileInNewTab('budget',i)">{{selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name}}</a></mat-label>
                            <mat-label *ngIf="!selectedBudgetFile[((currentPage - 1) * pageSize + i)] && !selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name">Upload Budget File</mat-label>
                            <button type="button" mat-icon-button (click)="triggerFileInput(i)">
                              <i matTooltip="{{selectedBudgetFile[((currentPage - 1) * pageSize + i)] && selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name ? 'Edit' : 'Upload Budget File'}}"
                                class="{{selectedBudgetFile[((currentPage - 1) * pageSize + i)] && selectedBudgetFile[((currentPage - 1) * pageSize + i)]?.name ? 'bi bi-pencil-fill' : 'bi bi-file-earmark-spreadsheet'}}"
                                id="edit-or-upload-icon"></i>
                            </button>
                          </div>
                          <div *ngIf="emp?.get('budget_file')?.touched && emp?.get('budget_file')?.invalid"
                            style="font-size: 11px;padding-left: 10px;color:#f44336">
                            <span *ngIf="emp?.get('budget_file')?.errors?.['accept']">Invalid file type. Please upload .xlsx, .xls, .doc, .docx, .pdf file.</span>
                            <span *ngIf="emp?.get('budget_file')?.errors?.['maxSize']">File size exceeds 10MB.</span>
                          </div>
                        </div>                
            </td>
            <td formArrayName="details">
                <table class="table table-list">  
                    <thead>
                        <tr>
                            <th>MRP</th>
                            <th>CRP</th>
                            <th *ngIf="isEditItem">Action</th>
                        </tr>
                    </thead>
                    <tbody>
 <tr  *ngFor="let mrpCrpitem of mrpDetails(((currentPage - 1) * pageSize + i)).controls; let j = index" [formGroupName]="j">
                            <td> 
                              <div class="mx-0 my-1 px-0 justify-content-center">
                        <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
                        <mat-label>MRP {{ j + 1 }}</mat-label>
                        <input matInput type="number" placeholder="Enter MRP {{ j + 1 }}" formControlName="mrp" maxlength="3" minlength="1" autocomplete="off" (focusout)="setDefaultValueIfEmpty($event, ((currentPage - 1) * pageSize + i), j, 'mrp')" (keypress)="validateKeyPress($event)">
                       
                      </mat-form-field> 
                    </div>
                   <div class="row mx-0 my-1 px-0 justify-content-center">
                        <input type="file" accept=".xlsx,.xls,.doc,.docx,.pdf" formControlName="mrpFile" #mrpfileInput
                        (change)="onMrpFileSelected($event,((currentPage - 1) * pageSize + i),j)" hidden [attr.data-row]="((currentPage - 1) * pageSize + i)" [attr.data-mrp]="j" [required]="mrpCrpitem?.get('mrp')?.value > 0 && !selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]">
                      <div class="image-container w-100 d-flex justify-content-between align-items-center"
                        style="padding: 1px 15px;"
                        [ngClass]="{'is-invalid': mrpCrpitem?.get('mrpFile')?.touched && mrpCrpitem?.get('mrpFile')?.invalid}">
                        <mat-label *ngIf="selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name" [ngbTooltip]="selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name" ><a type="button" (click)="openFileInNewTab('mrp',((currentPage - 1) * pageSize + i),j)">{{selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name}}</a></mat-label>
                        <mat-label *ngIf="!selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && !selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name" >Upload MRP File</mat-label>
                        <button type="button" mat-icon-button (click)="triggerMrpFileInput(((currentPage - 1) * pageSize + i), j)">
                          <i matTooltip="{{selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name ? 'Edit' : 'Upload MRP File'}}"
                            class="{{selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedMrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name ? 'bi bi-pencil-fill' : 'bi bi-file-earmark-spreadsheet'}}"
                            id="edit-or-upload-icon"></i>
                        </button>
                      </div>
                      <div *ngIf="mrpCrpitem?.get('mrpFile')?.touched && mrpCrpitem?.get('mrpFile')?.invalid"
                        style="font-size: 11px;padding-left: 10px;color:#f44336">
                        <span *ngIf="mrpCrpitem?.get('mrpFile')?.errors?.['accept']">Invalid file type. Please upload .xlsx, .xls, .doc, .docx, .pdf file.</span>
                        <span *ngIf="mrpCrpitem?.get('mrpFile')?.errors?.['maxSize']">File size exceeds 10MB.</span>
                        <span *ngIf="mrpCrpitem?.get('mrpFile')?.errors?.['required']">
  MRP File is required when MRP > 0
</span>  
                      </div>
         
                       </div>
                    </td>
                            <td><div class="mx-0 my-1 px-0 justify-content-center"> 
                      <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
                      <mat-label>CRP {{ j + 1 }}</mat-label>
                      <input matInput type="number" placeholder="Enter CRP {{ j + 1 }}" formControlName="crp" autocomplete="off" maxlength="3" minlength="1" (focusout)="setDefaultValueIfEmpty($event, ((currentPage - 1) * pageSize + i), j, 'mrp')" (keypress)="validateKeyPress($event)">
                    </mat-form-field> 
                  </div>
                  <div class="mx-0 my-1 px-0 justify-content-center">
                      <input type="file" accept=".xlsx,.xls,.doc,.docx,.pdf" formControlName="crpFile" #crpfileInput
                      (change)="onCrpFileSelected($event,((currentPage - 1) * pageSize + i),j)" hidden [attr.data-row]="((currentPage - 1) * pageSize + i)" [attr.data-mrp]="j" [required]="mrpCrpitem?.get('crp')?.value > 0 && !selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]">
                    <div class="image-container w-100 d-flex justify-content-between align-items-center"
                      style="padding: 1px 15px;"
                      [ngClass]="{'is-invalid': mrpCrpitem?.get('crpFile')?.touched && mrpCrpitem?.get('crpFile')?.invalid}">
                      <mat-label *ngIf="selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name" [ngbTooltip]="selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name"><a type="button" (click)="openFileInNewTab('crp',((currentPage - 1) * pageSize + i),j)">{{selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name}}</a></mat-label>
                      <mat-label *ngIf="!selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && !selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name">Upload CRP File</mat-label>
                      <button type="button" mat-icon-button (click)="triggerCrpFileInput(((currentPage - 1) * pageSize + i),j)">
                        <i matTooltip="{{selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name ? 'Edit' : 'Upload CRP File'}}"
                          class="{{selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j] && selectedCrpFile?.[((currentPage - 1) * pageSize + i)]?.[j]?.name ? 'bi bi-pencil-fill' : 'bi bi-file-earmark-spreadsheet'}}"
                          id="edit-or-upload-icon"></i>
                      </button>
                    </div>
                    <div *ngIf="mrpCrpitem?.get('crpFile')?.touched && mrpCrpitem?.get('crpFile')?.invalid"
                      style="font-size: 11px;padding-left: 10px;color:#f44336">
                      <span *ngIf="mrpCrpitem?.get('crpFile')?.errors?.['accept']">Invalid file type. Please upload .xlsx, .xls, .doc, .docx, .pdf file.</span>
                      <span *ngIf="mrpCrpitem?.get('crpFile')?.errors?.['maxSize']">File size exceeds 10MB.</span>
                     <span *ngIf="mrpCrpitem?.get('crpFile')?.errors?.['required']">
 CRP File is required when CRP > 0
</span>  
                    </div>
                    
                  </div></td>
                            <td class="text-center" *ngIf="isEditItem">
                            <ng-container>
                        <img src="../../../../assets/images/Edit.svg" class="icon-image" type="button" container="body"
                          ngbTooltip="Edit"  *ngIf="mrpCrpitem?.get('mrp').disabled" (click)="editMrpCrpItem(((currentPage - 1) * pageSize + i),j)"/>
                          <img src="../../../../assets/images/tick.svg" class="icon-image" type="button" container="body"
                          ngbTooltip="Save" *ngIf="mrpCrpitem?.get('mrp').enabled" (click)="saveMrpCrpItem(((currentPage - 1) * pageSize + i),j)" />
                          <img  src="../../../../assets/images/Delete.svg" class="icon-image" type="button" container="body"
                          ngbTooltip="Delete"  (click)="deleteMrpCrpItem(((currentPage - 1) * pageSize + i),j)"/>
                    </ng-container>    
                            </td>
                        </tr>

                    </tbody>
                   <tfoot>
  <tr>
    <td><strong>Total MRP:</strong>&nbsp;{{getTotalMrpValue(i)}}</td>
    <td><strong>Total CRP:</strong>&nbsp;{{getTotalCrpValue(i)}}</td>
    <td *ngIf="isEditItem">
      <ng-container *ngIf="mrpDetails(((currentPage - 1) * pageSize + i)).controls.length<=4">
        <button mat-button class="cancel-button mat-btn-s" [disabled]="!isEditItem" (click)="addMrpCrpItem(((currentPage - 1) * pageSize + i))" *ngIf="mrpDetails(((currentPage - 1) * pageSize + i)).controls.length < 5">
        Add Mrp & Crp
      </button>
      </ng-container>
      
      <ng-container *ngIf="mrpDetails(((currentPage - 1) * pageSize + i)).controls.length===5">
        -
      </ng-container>
    </td>
  </tr>
</tfoot>
                </table>
            </td>
        </tr>
    </tbody>
</table>
</mat-expansion-panel>
</mat-accordion>

        </div>
        </div>
        <div class="row mx-0 my-1 px-0" *ngIf="employeeFormArray.controls.length >= 1">
          <div class="col-lg-5 px-0">
          </div>
          <div class="col-12 col-sm-12 col-md-12 col-lg-12 px-0">
            <mat-paginator [length]="employeeFormArray.length"
          [pageSize]="10"
          [pageIndex]="currentPage - 1"
          (page)="onPageChanged($event)">
        </mat-paginator>
          </div>
        </div>
    </form>
   
</section>
<div class="row mx-0 my-3 px-2" >
  <div class="col-12 col-sm-12 col-md-6 col-lg-3 align-content-center px-0">
      <button mat-button class="cancel-button mat-btn-s" type="button"  (click)="backBtnFunc()">
          Back</button>
      <button mat-raised-button class="proceedbtn mat-btn-s" type="submit" (click)="saveJobKPIDetails()" *ngIf="isEditItem && job_id">Submit</button>
    </div>
        </div>
</div>
    </div>

            </section> 
</div>
