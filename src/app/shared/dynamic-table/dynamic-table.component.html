<div class="px-4">
  <div class="row mx-0 my-2 px-0 align-items-center">
    <div class="col-sm-10 col-md-4 col-lg-3 mt-2 search-div">
      <input
        type="search"
        class="form-control p-3 sizeinput"
        [(ngModel)]="config.searchTerm"
        (input)="onSearch(config.searchTerm)"
        placeholder="Search"
        autocomplete="off"
      />
      <i
        *ngIf="!config.searchTerm"
        class="bi bi-search"
        id="search-icon-tab"
      ></i>
    </div>
    <div class="col-sm-10 col-md-4 col-lg-4" >
      <mat-form-field appearance="outline" style="height:30px !important;"  class="w-100 custom-mat-form-field">
        <mat-label>Enter a date range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date">
          <input matEndDate placeholder="End date">
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>


    <div class="col"></div>
    <div class="col-auto d-flex justify-content-end">
      <button
        mat-icon-button
        [matMenuTriggerFor]="downloadMenu"
        aria-label="Download"
        class="border rounded"
      >
        <i class="bi bi-download"></i>
      </button>
      <mat-menu #downloadMenu="matMenu" xPosition="after" yPosition="below">
        <button mat-menu-item (click)="downloadCSV()">
          <mat-icon style="color: green">table_view</mat-icon>
          <span>CSV</span>
        </button>
        <button mat-menu-item (click)="downloadPDF()">
          <mat-icon style="color: red">picture_as_pdf</mat-icon>
          <span>PDF</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-list">
      <thead>
        <tr>
          <th
            *ngFor="let col of config.columns"
            style="cursor: pointer; position: relative"
          >
            {{ col.label }}

            <!-- Sort Arrows -->
            <i
              *ngIf="!arrowState[col.key]"
              (click)="sort('asc', col.key)"
              class="bi bi-arrow-up ms-1"
            ></i>
            <i
              *ngIf="arrowState[col.key]"
              (click)="sort('desc', col.key)"
              class="bi bi-arrow-down ms-1"
            ></i>

            <!-- Filter Toggle Icon -->
            <ng-container *ngIf="col.filterable">
              <ng-container [ngSwitch]="col.filterType">
                <!-- Date filter -->
                <!-- <ng-container *ngSwitchCase="'date'">
                  <button
                    mat-icon-button
                    (click)="openDatePicker(col.key)"
                    class="ms-1 btn-menu-trigger"
                  >
                    <i class="bi bi-calendar"></i>
                  </button>
                </ng-container> -->
                <!-- Date filter button inside ngSwitchCase 'date' -->
                <ng-container *ngSwitchCase="'date'">
                  <button
                    mat-icon-button
                    (click)="setDateFilterColumn(col.key);picker.open()"
                    class="ms-1 btn-menu-trigger">
                    <i class="bi bi-calendar"></i>
                  </button>

                    <mat-form-field class="opacity-0 position-absolute">
                      <mat-label>Choose a date</mat-label>
                      <input matInput [matDatepicker]="picker"
                      [(ngModel)]="dateFilterValue"
                      (dateChange)="onDateSelected($event)">
                      <mat-hint>MM/DD/YYYY</mat-hint>
                      <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                </ng-container>

                <!-- Multi-select filter -->
                <ng-container *ngSwitchCase="'multi-select'">
                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="filterMenu"
                    (click)="openFilterMenu($event, col.key)"
                    #trigger="matMenuTrigger"
                    class="ms-1 btn-menu-trigger"
                  >
                    <i class="bi bi-toggles"></i>
                  </button>
                  <ng-container *ngIf="!filterTriggers[col.key]">
                    {{ (filterTriggers[col.key] = trigger) }}
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr
          *ngFor="
            let item of paginatedData
              | customSort : directionValue : sortValue
              | paginate
                : {
                    itemsPerPage: tableSize,
                    currentPage: 1,
                    totalItems: 10
                  }"
            >
          <td *ngFor="let col of config.columns">
            <div *ngIf="col.key !== 'employee';">
              {{
                col.type === "date"
                  ? (item[col.key] | date : "dd-MM-yyyy")
                  : item[col.key] || "NA"
              }}
            </div>

            <ng-container *ngIf="col.key === 'employee';">
              <a (click)="navigateToEmployee(item)" class="text-primary text-decoration-underline" style="cursor: pointer;">
                {{ item[col.key] || 'NA' }}
              </a>
            </ng-container>
          </td>

          <td *ngIf="config.actions?.length">
            <ng-container *ngFor="let act of config.accessConfig">
              <button
                *ngIf="config.actions.includes(act)"
                (click)="triggerAction(act, item)"
                class="btn btn-sm"
                [ngClass]="{
                  'text-danger': act === 'DELETE',
                  'text-success': act === 'ACCEPT',
                  'text-warning': act === 'REJECT'
                }"
                [title]="act"
              >
                <i
                  [ngClass]="{
                    'fas fa-trash-alt': act === 'DELETE',
                    'bi bi-check-circle': act === 'ACCEPT',
                    'bi bi-x-circle': act === 'REJECT'
                  }"
                ></i>
              </button>
            </ng-container>
          </td>
        </tr>

        <tr *ngIf="paginatedData.length === 0">
          <td colspan="100%" class="text-center">No records found!</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination-container pt-4">
    <!-- Pagination Controls (Center-Aligned) -->
    <pagination-controls
      previousLabel="Prev"
      nextLabel="Next"
      (pageChange)="onTableDataChange($event)"
    >
    </pagination-controls>

    <!-- Items Per Page Selector (Right-Aligned) -->
    <div class="items-per-page-container px-4">
      <div>Items per page</div>
      <mat-select
        [(ngModel)]="tableSize"
        (selectionChange)="onTableSizeChange($event)"
        placeholder="10"
        class="page-size"
      >
        <mat-option *ngFor="let size of tableSizes" [value]="size">{{size}}</mat-option>
      </mat-select>
    </div>
  </div>
</div>

<!---Filter-->
<mat-menu #filterMenu="matMenu" class="p-2" xPosition="after" yPosition="below">
  <ng-container *ngIf="activeFilterColumn as columnKey">
    <!-- Bootstrap Search Bar -->
    <div class="position-relative mb-2" (click)="$event.stopPropagation()">
      <!-- Search/Clear Icon -->
      <i
        class="bi text-secondary position-absolute top-50 end-0 translate-middle-y me-2"
        [ngClass]="{
          'bi-x-lg': filterSearchText[columnKey],
          'bi-search': !filterSearchText[columnKey]
        }"
        style="cursor: pointer;"
        (click)="filterSearchText[columnKey] && (filterSearchText[columnKey] = '')"
      ></i>

      <!-- Input -->
      <input
        type="text"
        class="form-control"
        placeholder="Search"
        [(ngModel)]="filterSearchText[columnKey]"
      />
    </div>


    <mat-selection-list
      [(ngModel)]="columnFilters[columnKey]"
      (ngModelChange)="applyFilters()"
      [multiple]="true"
    >
      <mat-list-option
        *ngFor="let option of getFilteredOptions(columnKey)"
        [value]="option"
      >
        {{ option }}
      </mat-list-option>
    </mat-selection-list>
  </ng-container>
</mat-menu>






