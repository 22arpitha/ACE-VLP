<div class="px-4 settings-table-bg">
  <div class="row mx-0 my-3 px-0 align-items-center">
    <!-- Search Field -->
    <div class="col-12 mt-2 col-sm-12 col-md-4 col-lg-3 search-div px-0 position-relative" *ngIf="config.searchable">
      <input
        type="search"
        class="form-control p-2 sizeinput"
        [(ngModel)]="config.searchTerm"
        (input)="onSearch(config.searchTerm)"
        placeholder="Search"
        autocomplete="off"
        aria-describedby="emailHelp"
      />
      <i *ngIf="!config.searchTerm" class="bi bi-search" id="search-icon-tab"></i>
    </div>
    <div class="col-auto mt-2 col-sm-auto col-md-auto col-lg-2" *ngIf="config?.showIncludeAllJobs">
      <mat-checkbox color="primary" class="example-margin" [(ngModel)]="config.includeAllJobsValue" [ngModelOptions]="{standalone: true}" [disabled]="config.includeAllJobsEnable" (change)="onIncludeJobsChange($event)" ><h5 class="c-headerss">Include All Jobs</h5></mat-checkbox>
    </div>
    <!-- Date Range Filter -->
    <div class="col-12 mt-2 col-sm-12 col-md-4 col-lg-3" *ngIf="config.dateRangeFilter">
      <mat-form-field appearance="outline" class="w-100 custom-mat-form-field">
        <mat-label>&nbsp; Enter a date range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate placeholder="Start date" />
          <input matEndDate placeholder="End date" />
        </mat-date-range-input>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
    </div>

    <!-- Spacer -->
    <div class="col"></div>
      <!-- Tab design -->
     <div class="col-auto mt-2 col-sm-auto col-md-auto col-lg-auto" *ngIf="config?.headerTabs">
        <button mat-raised-button class="mat-btn-s tab-button-content" [ngClass]="{'isActive': isCurrent}" type="button" type="button" (click)="getCurrentDatasetList()">Current</button>
        <button mat-raised-button class="mat-btn-s tab-button-content" [ngClass]="{'isActive': isHistory}" type="button" type="button" (click)="getHistoryDatasetList()">History</button>
      </div>
<!-- Download Menu -->
    <div class="col-auto col-sm-auto col-md-auto mt-2 col-lg-1" *ngIf="!config?.hideDownload" >
      <button
        mat-icon-button
        [matMenuTriggerFor]="downloadMenu"
        aria-label="Download"
        class="border rounded menu-trigger"
      >
        <i class="bi bi-download"></i>
      </button>
      <mat-menu #downloadMenu="matMenu" xPosition="after" yPosition="below">
        <button mat-menu-item (click)="downloadCSV()">
          <mat-icon style="color: green">table_view</mat-icon>
          <span>CSV</span>
        </button>
        <button mat-menu-item (click)="downloadPDF()">
          <mat-icon style="color: red">picture_as_pdf</mat-icon>
          <span>PDF</span>
        </button>
      </mat-menu>
    </div>
    <div class="col-auto mt-2 col-sm-auto col-md-auto col-lg-2 text-end" *ngIf="config?.sendEmail">
      <button mat-raised-button class="mat-btn-s proceedbtn" type="button" type="button" (click)="sendEmailEvent()">Send Email</button>
    </div>
  </div>

  <!-- Data Table -->
   <div [ngClass]="!config?.hideDownload ? 'scroll-h' : ''">
  <div class="table-responsive">
    <table class="table table-hover table-list">
      <thead>
        <tr>
          <th *ngFor="let col of config.columns" style="cursor: pointer; position: relative">
            {{ col.label }}

            <!-- Sort Icons -->
            <i *ngIf="!arrowState[col.key]" (click)="sort('asc', col.key)" class="bi bi-arrow-up ms-1"></i>
            <i *ngIf="arrowState[col.key]" (click)="sort('desc', col.key)" class="bi bi-arrow-down ms-1"></i>

            <!-- Filter Buttons -->
            <ng-container *ngIf="col.filterable">
              <ng-container [ngSwitch]="col.filterType">
                <ng-container *ngSwitchCase="'date'">
                  <button
                    mat-icon-button
                    (click)="setDateFilterColumn(col.key); picker.open()"
                    class="ms-1 btn-menu-trigger"
                  >
                    <i class="bi bi-calendar"></i>
                  </button>
                  <mat-form-field class="opacity-0 position-absolute">
                    <mat-label>Choose a date</mat-label>
                    <input
                      matInput
                      [matDatepicker]="picker"
                      [(ngModel)]="dateFilterValue"
                      (dateChange)="onDateSelected($event)"
                    />
                    <mat-hint>MM/DD/YYYY</mat-hint>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>
                </ng-container>

                <ng-container *ngSwitchCase="'multi-select'">
                  <button
                    mat-icon-button
                    [matMenuTriggerFor]="filterMenu"
                    (click)="openFilterMenu($event, col.key)"
                    #trigger="matMenuTrigger"
                    class="ms-1 btn-menu-trigger"
                  >
                  <i class="bi bi-toggles"></i>
                  </button>
                  <ng-container *ngIf="!filterTriggers[col.key]">
                    {{ (filterTriggers[col.key] = trigger) }}
                  </ng-container>
                  <!-- Multi-select Filter Menu -->

                  <mat-menu #filterMenu="matMenu" class="p-2" xPosition="after" yPosition="below" >
                    <ng-container *ngIf="activeFilterColumn as columnKey">
                      <div class="position-relative mb-2" (click)="$event.stopPropagation()">
                        <i
                          class="bi text-secondary position-absolute top-50 end-0 translate-middle-y me-2"
                          [ngClass]="{
                            'bi-x-lg': filterSearchText[columnKey],
                            'bi-search': !filterSearchText[columnKey]
                          }"
                          style="cursor: pointer"
                          (click)="filterSearchText[columnKey] && (filterSearchText[columnKey] = '')"
                        ></i>
                        <input
                          type="text"
                          class="form-control"
                          placeholder="Search"
                          [(ngModel)]="filterSearchText[columnKey]"
                        />
                      </div>

                      <mat-selection-list
                        [(ngModel)]="columnFilters[columnKey]"
                        (ngModelChange)="applyFilters()"
                        [multiple]="true"
                      >
                        <mat-list-option
                          *ngFor="let option of getFilteredOptions(columnKey)"
                          [value]="option"
                        >
                          {{ option }}
                        </mat-list-option>
                      </mat-selection-list>
                    </ng-container>
                  </mat-menu>
                </ng-container>
              </ng-container>
            </ng-container>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr
          *ngFor="
            let item of paginatedData
              | customSort: directionValue : sortValue
              | paginate: paginationConfig
          "
        >
          <td *ngFor="let col of config.columns">
            <div *ngIf="!col.navigation">
              {{ col.type === 'date' ? (item[col.key] | date: 'dd-MM-yyyy') : item[col.key] || 'NA' }}
            </div>
            <ng-container *ngIf="col.navigation">
              <a
                (click)="navigateToEmployee(item[col.key])"
                class="text-primary text-decoration-underline"
                style="cursor: pointer"
              >
                {{ item[col.key] || 'NA' }}
              </a>
            </ng-container>
          </td>

          <td *ngIf="config.actions?.length">
            <ng-container *ngFor="let act of config.accessConfig">
              <button
                *ngIf="config.actions.includes(act)"
                (click)="triggerAction(act, item)"
                class="btn btn-sm"
                [ngClass]="{
                  'text-danger': act === 'DELETE',
                  'text-success': act === 'ACCEPT',
                  'text-warning': act === 'REJECT'
                }"
                [title]="act"
              >
                <i
                  [ngClass]="{
                    'fas fa-trash-alt': act === 'DELETE',
                    'bi bi-check-circle': act === 'ACCEPT',
                    'bi bi-x-circle': act === 'REJECT'
                  }"
                ></i>
              </button>
            </ng-container>
          </td>
        </tr>


      </tbody>
    </table>

    <div class="row mx-1 my-2 px-0" *ngIf="paginatedData.length === 0">
      <app-generic-norecards></app-generic-norecards>
    </div>
  </div>
  </div>
    <div class="row m-0 text-end pt-2" *ngIf="config?.estimationDetails">
      <div class="col-3"></div>
      <div class="col-3">
        <span class="fw-bold">Estimated (hrs) : {{ estimatedTotal.toFixed(2) }}</span>
      </div>
      <div class="col-3">
        <span class="fw-bold">Actual Time (hrs) : {{ actualTotal.toFixed(2) }}</span>
      </div>
      <div class="col-3">
        <span class="fw-bold">Average Productivity : {{ averageProductivity.toFixed(2) }}%</span>
      </div>

    </div>


    <div class="row m-0 text-end pt-2" *ngIf="config?.averageProductivity">
      <div class="col-9"></div>
      <div class="col-3">
        <span class="fw-bold">Average Productivity : {{ 'NA' }}</span>
      </div>
    </div>

</div>

<!-- Pagination -->
<div class="pagination-container pt-4">
  <!-- Pagination Controls (Center-Aligned) -->
  <pagination-controls
    previousLabel="Prev"
    nextLabel="Next"
    (pageChange)="onTableDataChange($event)"
  >
  </pagination-controls>

  <!-- Items Per Page Selector (Right-Aligned) -->
  <div class="items-per-page-container px-1">
    <div>Items per page</div>
    <mat-select
      [(ngModel)]="tableSize"
      (selectionChange)="onTableSizeChange($event)"
      placeholder="10"
      class="page-size"
    >
      <mat-option *ngFor="let size of tableSizes" [value]="size">{{size}}</mat-option>
    </mat-select>
  </div>
</div>


